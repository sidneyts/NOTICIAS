<!DOCTYPE html>
<html lang="pt-BR" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Vídeo de Notícias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        // Lógica para Modo Escuro
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark')
        } else {
          document.documentElement.classList.remove('dark')
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .file-input-label { display: block; padding: 0.75rem 1.25rem; border-radius: 0.5rem; background-color: #4f46e5; color: white; cursor: pointer; text-align: center; transition: background-color 0.2s; }
        .file-input-label:hover { background-color: #4338ca; }
        .file-input { display: none; }
        .file-name { margin-top: 0.5rem; display: block; font-style: italic; color: #6b7280; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #previewContainer { border: 2px dashed #cbd5e1; background-color: #f8fafc; }
        .dark #previewContainer { border-color: #4b5563; background-color: #1f2937; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">
    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Coluna de Controles -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8">
                <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-2 text-center">Gerador de Vídeo</h1>
                <p class="text-gray-500 dark:text-gray-400 mb-8 text-center">Ajuste os controles e veja o preview ao lado.</p>

                <form id="videoForm" onsubmit="event.preventDefault(); return false;">
                    <div class="space-y-6">
                        <!-- Seção de Textos -->
                        <fieldset class="border p-4 rounded-lg border-gray-300 dark:border-gray-600">
                            <legend class="text-lg font-semibold px-2 text-gray-700 dark:text-gray-300">Textos Principais</legend>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-2">
                                <div>
                                    <label for="retranca" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Retranca</label>
                                    <input type="text" id="retranca" name="retranca" class="control-input w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-lg shadow-sm">
                                </div>
                                <div>
                                    <label for="titulo" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Título</label>
                                    <textarea id="titulo" name="titulo" rows="3" class="control-input w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-lg shadow-sm"></textarea>
                                </div>
                            </div>
                        </fieldset>
                        
                        <!-- Seção de Controles da Retranca -->
                        <fieldset class="border p-4 rounded-lg border-gray-300 dark:border-gray-600">
                            <legend class="text-lg font-semibold px-2 text-gray-700 dark:text-gray-300">Controles da Retranca</legend>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-6 mt-2">
                                <div>
                                    <label for="fontSizeRetranca" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tamanho Fonte</label>
                                    <input type="number" id="fontSizeRetranca" name="fontSizeRetranca" class="control-input w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-lg shadow-sm">
                                </div>
                                <div>
                                    <label for="posXRetranca" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Posição X</label>
                                    <input type="number" id="posXRetranca" name="posXRetranca" class="control-input w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-lg shadow-sm">
                                </div>
                                <div>
                                    <label for="posYRetranca" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Posição Y</label>
                                    <input type="number" id="posYRetranca" name="posYRetranca" class="control-input w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-lg shadow-sm">
                                </div>
                            </div>
                        </fieldset>

                         <!-- Seção de Controles do Título -->
                        <fieldset class="border p-4 rounded-lg border-gray-300 dark:border-gray-600">
                            <legend class="text-lg font-semibold px-2 text-gray-700 dark:text-gray-300">Controles do Título</legend>
                            <div class="grid grid-cols-2 md:grid-cols-2 gap-6 mt-2">
                                <div>
                                    <label for="fontSizeTitulo" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tamanho Fonte</label>
                                    <input type="number" id="fontSizeTitulo" name="fontSizeTitulo" class="control-input w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-lg shadow-sm">
                                </div>
                                <div>
                                    <label for="letterSpacingTitulo" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Espaço Letras (px)</label>
                                    <input type="number" id="letterSpacingTitulo" name="letterSpacingTitulo" class="control-input w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-lg shadow-sm">
                                </div>
                                 <div>
                                    <label for="lineSpacingTitulo" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Espaço Linhas (px)</label>
                                    <input type="number" id="lineSpacingTitulo" name="lineSpacingTitulo" class="control-input w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-lg shadow-sm">
                                </div>
                                <div></div> <!-- Placeholder -->
                                <div>
                                    <label for="posXTitulo" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Posição X</label>
                                    <input type="number" id="posXTitulo" name="posXTitulo" class="control-input w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-lg shadow-sm">
                                </div>
                                <div>
                                    <label for="posYTitulo" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Posição Y</label>
                                    <input type="number" id="posYTitulo" name="posYTitulo" class="control-input w-full px-4 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 rounded-lg shadow-sm">
                                </div>
                            </div>
                        </fieldset>

                        <!-- Upload de Arquivos -->
                        <fieldset class="border p-4 rounded-lg border-gray-300 dark:border-gray-600">
                             <legend class="text-lg font-semibold px-2 text-gray-700 dark:text-gray-300">Arquivo de Mídia</legend>
                            <div class="flex justify-center items-center text-sm mt-2">
                                <div>
                                    <label for="userMedia" class="file-input-label">Mídia de Fundo (Imagem/Vídeo)</label>
                                    <input type="file" id="userMedia" name="userMedia" class="file-input" accept="image/png,image/jpeg,video/mp4,video/webm" required>
                                    <span id="userMediaName" class="file-name dark:text-gray-400">Nenhum</span>
                                </div>
                            </div>
                        </fieldset>
                    </div>

                    <!-- Botão de Gerar -->
                    <div class="mt-10">
                        <button type="button" id="generateBtn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-green-700 transition-transform transform hover:scale-105">
                            Gerar Vídeo Final
                        </button>
                    </div>
                </form>
                <div id="status" class="mt-6 text-center min-h-[2.5rem]"></div>
            </div>

            <!-- Coluna de Preview -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 flex flex-col items-center justify-center">
                 <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4">Preview (Frame @ 5s)</h2>
                 <div id="previewContainer" class="w-full aspect-video flex items-center justify-center rounded-lg overflow-hidden">
                    <img id="previewImage" src="" alt="Preview do vídeo aparecerá aqui" class="w-full h-full object-contain" style="display: none;"/>
                    <div id="previewPlaceholder" class="text-gray-400 dark:text-gray-500">Carregue a mídia para ver o preview</div>
                 </div>
                 <p id="previewStatus" class="mt-4 text-gray-500 dark:text-gray-400 text-sm h-5"></p>
            </div>
        </div>
    </div>

    <script>
        function debounce(func, timeout = 1000){
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }

        const form = document.getElementById('videoForm');
        const previewStatus = document.getElementById('previewStatus');
        const previewImage = document.getElementById('previewImage');
        const previewPlaceholder = document.getElementById('previewPlaceholder');

        async function saveSettings() {
            const settings = {};
            document.querySelectorAll('.control-input').forEach(input => {
                if(input.name) {
                    settings[input.name] = input.value;
                }
            });
            try {
                await fetch('http://127.0.0.1:5000/save-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                console.log("Settings saved.");
            } catch (error) {
                console.error("Failed to save settings:", error);
            }
        }

        async function updatePreview() {
            const userMediaName = document.getElementById('userMediaName').textContent;
            if (userMediaName === 'Nenhum' || userMediaName === '') {
                return;
            }
            
            previewStatus.textContent = "Atualizando preview...";
            previewImage.style.display = 'none';
            previewPlaceholder.style.display = 'block';
            previewPlaceholder.textContent = 'Carregando...';
            
            const formData = new FormData(form);
            
            try {
                // O preview não precisa do ficheiro, pois ele já está no servidor
                const response = await fetch('http://127.0.0.1:5000/preview-frame', {
                    method: 'POST',
                    body: formData,
                });
                const result = await response.json();

                if (response.ok) {
                    const fullPreviewUrl = `http://127.0.0.1:5000${result.previewUrl}?t=${new Date().getTime()}`;
                    previewImage.src = fullPreviewUrl;
                    previewImage.style.display = 'block';
                    previewPlaceholder.style.display = 'none';
                    previewStatus.textContent = "Preview atualizado.";
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                previewStatus.textContent = `Erro no preview: ${error.message}`;
                previewPlaceholder.textContent = `Erro: ${error.message}`;
                console.error("Preview Error:", error);
            }
        }

        const debouncedSaveAndPreview = debounce(() => {
            saveSettings();
            updatePreview();
        }, 1000);

        document.querySelectorAll('.control-input').forEach(input => {
            input.addEventListener('input', debouncedSaveAndPreview);
        });

        window.addEventListener('load', async () => {
            try {
                const response = await fetch('http://127.0.0.1:5000/load-settings');
                const settings = await response.json();
                if (response.ok) {
                    for (const key in settings) {
                        const element = document.getElementById(key);
                        if (element) {
                            element.value = settings[key];
                        }
                    }
                    if (settings.userMediaOriginalFilename) {
                        document.getElementById('userMediaName').textContent = settings.userMediaOriginalFilename;
                    }
                }
            } catch (error) {
                console.error("Failed to load settings:", error);
            }

            const defaultPreviewUrl = `http://127.0.0.1:5000/preview.jpg?t=${new Date().getTime()}`;
            previewImage.src = defaultPreviewUrl;
            previewImage.onerror = () => {
                previewImage.style.display = 'none';
                previewPlaceholder.style.display = 'block';
            };
            previewImage.onload = () => {
                previewImage.style.display = 'block';
                previewPlaceholder.style.display = 'none';
            };
        });

        document.getElementById('generateBtn').addEventListener('click', async function() {
            const statusDiv = document.getElementById('status');
            const generateBtn = this;
            const userMediaName = document.getElementById('userMediaName').textContent;

            if (userMediaName === 'Nenhum' || userMediaName === '') {
                statusDiv.innerHTML = `<p class="text-red-500 font-semibold">Por favor, carregue a Mídia de Fundo.</p>`;
                return;
            }
            
            const formData = new FormData(form);

            statusDiv.innerHTML = `<div class="flex items-center justify-center text-blue-600 dark:text-blue-400"><svg class="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg><p class="font-semibold">Processando... Isso pode levar vários minutos.</p></div>`;
            generateBtn.disabled = true;
            generateBtn.classList.add('opacity-50');

            try {
                const response = await fetch('http://127.0.0.1:5000/generate-video', { method: 'POST', body: formData });
                const result = await response.json();
                if (response.ok) {
                    statusDiv.innerHTML = `<a href="http://127.0.0.1:5000${result.downloadUrl}" target="_blank" class="inline-block bg-purple-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-purple-700 transition">Download do Vídeo Pronto</a>`;
                } else { throw new Error(result.error || 'Erro desconhecido no servidor.'); }
            } catch (error) {
                statusDiv.innerHTML = `<p class="text-red-500 font-semibold">Erro: ${error.message}</p>`;
            } finally {
                generateBtn.disabled = false;
                generateBtn.classList.remove('opacity-50');
            }
        });

        document.getElementById('userMedia').addEventListener('change', async function() {
            const file = this.files[0];
            const spanElement = document.getElementById('userMediaName');
            if (!file) {
                spanElement.textContent = 'Nenhum';
                return;
            }
            
            spanElement.textContent = file.name;
            previewStatus.textContent = "Enviando mídia para o servidor...";

            const uploadFormData = new FormData();
            uploadFormData.append('userMedia', file);

            try {
                const response = await fetch('http://127.0.0.1:5000/upload-media', {
                    method: 'POST',
                    body: uploadFormData,
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error);
                
                console.log("Upload successful, updating preview.");
                updatePreview();
            } catch (error) {
                previewStatus.textContent = `Erro no upload: ${error.message}`;
            }
        });
    </script>
</body>
</html>
